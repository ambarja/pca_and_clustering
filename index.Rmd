---
title: "Analysis of PCA and clustering for San Diego"
output: 
  html_document:
    toc: true
    toc_float:
      collapsed: false
      smooth_scroll: false
    toc_depth: 2
theme: united
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(fig.width = 12,fig.height = 9)
```

# Requeriments

```{r message=FALSE,warning=FALSE}
library(tidyverse)
library(psych)
library(raster)
library(ggcorrplot)
library(cptcity)
library(cowplot)
library(colorspace)
library(rasterVis)
```

# Reading of data

```{r message=FALSE,warning=FALSE}
brick_sandiego <- brick('SanDiego_test.tif')
names(brick_sandiego) <-  c('nldc','tree','imp','ndvi','tmax','tmin')

```


# Simple visualization of bands 

```{r message=FALSE,warning=FALSE}
nldc <- levelplot(brick_sandiego$nldc,
          col.regions = cpt('mpl_magma',rev = TRUE),
          main = "nldc",
          margin = FALSE,
          xlab = '',
          ylab = '' ,
          colorkey = list(space = 'bottom')
          )

tree <- levelplot(brick_sandiego$tree,
          col.regions = cpt('ocal_green',rev = TRUE),
          main = "%Tree",
          margin = FALSE,
          xlab = '',
          ylab = '' ,
          colorkey = list(space = 'bottom')
          )

imp <- levelplot(brick_sandiego$imp,
          col.regions = cpt('grass_evi'),
          main = "Imperious",
          margin = FALSE,
          xlab = '',
          ylab = '' ,
          colorkey = list(space = 'bottom')
          )


ndvi <- levelplot(brick_sandiego$ndvi,
          col.regions = cpt('grass_ndvi'),
          main = "NDVI",
          margin = FALSE,
          xlab = '',
          ylab = '' ,
          colorkey = list(space = 'bottom')
          )

tmax <- levelplot(brick_sandiego$tmax,
          col.regions = cpt('grass_bcyr'),
          main = "Tmax",
          margin = FALSE,
          xlab = '',
          ylab = '' ,
          colorkey = list(space = 'bottom')
          )

tmin <- levelplot(brick_sandiego$tmin,
          col.regions = cpt('grass_bcyr'),
          main = "Tmin",
          margin = FALSE,
          xlab = '',
          ylab = '' ,
          colorkey = list(space = 'bottom')
          )

plot_grid(nldc, tree, imp, ndvi, tmax, tmin)

```


# Newdataframe form rasterdata

```{r message=FALSE,warning=FALSE}
df_sandiego <- as.data.frame(brick_sandiego, xy = TRUE)

xydf <-  df_sandiego %>%
   dplyr::select(x, y) 

dataset <- df_sandiego %>%
   drop_na()
```


# Heuristic Criterion in PCA
```{r plot_cor, message=FALSE,warning=FALSE}
matrix_cor <- dataset %>%
   dplyr::select(-c(x,y)) %>% 
   cor()

ggcorrplot(corr = matrix_cor,
           ggtheme = theme_minimal(),
           title = 'Matrix of variables correlation',
           lab = TRUE,
           colors = cpt(pal = 'mpl_viridis',n=3),
           lab_col = 'white')

```

# Test KMO ~ MSA 
```{r message=TRUE}
# (measure of sampling adequacy, MSA >=7)
KMO(r = matrix_cor) 
```


# Principal Component Analysis 

```{r message=FALSE,warning=FALSE}
san_diego <- dataset %>%
   dplyr::select(c(-x,-y)) %>% 
   prcomp(scale. = TRUE) 
summary(san_diego)
# SanDiego => 4PCA >= 80% accumulated variance 
```

## Eingvector de PCA

```{r message=FALSE,warning=FALSE}
eingvector <- san_diego$rotation[,1:4]
eingvector
```

$$PC_{1} = -0.4118xndlc + 0.5161ximp + 0.5161xtree - 0.4063xndvi + 0.0781xtmax + 0.3473xtmin$$
$$PC_{2} = 0.1821xndlc + -0.1491ximp + -0.1491xtree +-0.1596xndvi + 0.9071xtmax + 0.2719xtmin$$

$$PC_{3} = -0.3101xndlc +0.1869ximp + 0.1869xtree + + 0.1859xndvi -0.3966 xtmax - -0.8012xtmin$$

```{r pcs-plots,message=FALSE,warning=FALSE}
pc1 <- eingvector %>% 
   as_tibble() %>%
   mutate(name = rownames(eingvector)) %>% 
   ggplot(aes(x = PC1,
              y = name,
              fill = PC1)) + 
   geom_bar(stat = 'identity',
            color = "black",
            lwd = 0.2,
            alpha = 0.9) +
   scale_fill_continuous_diverging(palette = "Blue-Red 3") +
   theme_minimal() + 
   labs(title = 'PC1-Without rotation varimax',
        x = ' ',
        y = ' ') + 
   theme(legend.position = 'top',
         legend.justification = 'center',
         plot.title = element_text(hjust = 0.5,
                                   size = 11,
                                   face = 'bold'))

pc2 <- eingvector %>% 
   as_tibble() %>%
   mutate(name = rownames(eingvector)) %>% 
   ggplot(aes(x = PC2,y = name, fill = PC2)) + 
    geom_bar(stat = 'identity',
            color = "black",
            lwd = 0.2,
            alpha = 0.9) +
   scale_fill_continuous_diverging(palette = "Blue-Red 3") +
   theme_minimal() + 
   labs(title = 'PC2-Without rotation varimax',
        x = ' ',
        y = ' ') + 
   theme(legend.position = 'top',
         legend.justification = 'center',
         plot.title = element_text(hjust = 0.5,
                                   size = 11,
                                   face = 'bold'))

pc3 <- eingvector %>% 
   as_tibble() %>%
   mutate(name = rownames(eingvector)) %>% 
   ggplot(aes(x = PC3,y = name, fill = PC3)) + 
  geom_bar(stat = 'identity',
            color = "black",
            lwd = 0.2,
            alpha = 0.9) +
   scale_fill_continuous_diverging(palette = "Blue-Red 3") +
   theme_minimal() + 
   labs(title = 'PC3-Without rotation varimax',
        x = ' ',
        y = ' ') + 
   theme(legend.position = 'top',
         legend.justification = 'center',
         plot.title = element_text(hjust = 0.5,
                                   size = 11,
                                   face = 'bold'))

plot_grid(pc1,pc2,pc3,ncol = 3)
```


# Eingvalues de PCA ~ SanDiego
```{r message=FALSE,warning=FALSE}
eingvalues <- tibble(
   Components = sprintf('pc%s',1:6),
   variance = san_diego$sdev^2/sum(san_diego$sdev^2)) %>% 
      mutate(accumulated = cumsum(variance))
eingvalues

```

# Screen plot 
```{r screen_plot, message=FALSE,warning=FALSE}
eingvalues %>% 
   ggplot(aes(x = Components,y = variance, group = 1)) +
   geom_bar(stat = 'identity', fill = "#699bff") + 
   geom_line() + 
   geom_point(aes(size = variance))  + 
   theme_minimal() +
   labs(title = 'Screen plot',x = '') +
   theme(legend.position = 'none',
         plot.title = element_text(hjust = 0.5,
                                   size = 20,
                                   face = 'bold'))
```

# Criterion Kaiser eingvalues > 1

```{r varimax_plot, message=FALSE,warning=FALSE}
eingvalues_kaiser <- varimax(san_diego$x)
loadings_rot <- eingvalues_kaiser$rotmat %>% 
   as_tibble() %>%
   mutate(name = rownames(eingvector))
names(loadings_rot)[1:6] <- sprintf('rot%s',1:6)

rot1 <- loadings_rot %>% 
   ggplot(aes(x = rot1 ,y = name, fill = rot1)) + 
   geom_bar(stat = 'identity',
            color = "black",
            lwd = 0.2,
            alpha = 0.9) +
   scale_fill_continuous_diverging(palette = "Blue-Red 3") +
   theme_minimal() + 
   labs(title = 'PC1-With rotation varimax',
        x = ' ',
        y = ' ') + 
   theme(legend.position = 'top',
         legend.justification = 'center',
         plot.title = element_text(hjust = 0.5,
                                   size = 11,
                                   face = 'bold'))

rot2 <- loadings_rot %>% 
   ggplot(aes(x = rot2,y = name, fill = rot2)) + 
   geom_bar(stat = 'identity',
            color = "black",
            lwd = 0.2,
            alpha = 0.9) +
   scale_fill_continuous_diverging(palette = "Blue-Red 3") +
   theme_minimal() + 
   labs(title = 'PC2-With rotation varimax',
        x = ' ',
        y = ' ') + 
   theme(legend.position = 'top',
         legend.justification = 'center',
         plot.title = element_text(hjust = 0.5,
                                   size = 11,
                                   face = 'bold'))

rot3 <- loadings_rot %>% 
   ggplot(aes(x = rot3,y = name, fill = rot3)) + 
   geom_bar(stat = 'identity',
            color = "black",
            lwd = 0.2,
            alpha = 0.9) +
   scale_fill_continuous_diverging(palette = "Blue-Red 3") +
   theme_minimal() + 
   labs(title = 'PC3-With rotation varimax',
        x = ' ',
        y = ' ') + 
   theme(legend.position = 'top',
         legend.justification = 'center',
         plot.title = element_text(hjust = 0.5,
                                   size = 11,
                                   face = 'bold'))

plot_grid(rot1,rot2,rot3,ncol = 3)
```

# PC with PC kaiser
```{r message=FALSE,warning=FALSE}
row1 <- plot_grid(pc1,pc2,pc3,ncol = 3)
row2 <- plot_grid(rot1,rot2,rot3,ncol = 3)
plot_grid(row1,row2,nrow = 2)
```

# New raster with 3PCA
```{r message=FALSE,warning=FALSE}
dataset_pcs <- cbind(dataset,san_diego$x[,1:3])
sandiego_pca <- xydf %>%
   left_join(y = dataset_pcs,by = c('y','x'))
newraster <- sandiego_pca %>%
   dplyr::select(x, y, PC1, PC2, PC3)

```

# Parameters of new raster

```{r message=FALSE,warning=FALSE}
sandiego_crs  <- crs(brick_sandiego)
sandiego_res <- res(brick_sandiego)
sandiego_newraster <- rasterFromXYZ(
   newraster,
   sandiego_res,
   sandiego_crs
   )
```

# Plot PCA
```{r message=FALSE,warning=FALSE}
pc1 <- levelplot(sandiego_newraster$PC1,
          col.regions = cpt('mpl_magma',rev = TRUE),
          main = "PC1",
          margin = FALSE,
          xlab = '',
          ylab = '' ,
          colorkey = list(space = 'bottom')
          )

pc2 <- levelplot(sandiego_newraster$PC2,
          col.regions = cpt('mpl_viridis',rev = TRUE),
          main = "PC2",
          margin = FALSE,
          xlab = '',
          ylab = '' ,
          colorkey = list(space = 'bottom')
          )

pc3 <- levelplot(sandiego_newraster$PC3,
          col.regions = cpt('mpl_plasma'),
          main = "PC3",
          margin = FALSE,
          xlab = '',
          ylab = '' ,
          colorkey = list(space = 'bottom')
          )

plot_grid(pc1, pc2, pc3,ncol = 3)

```  


# Clustering Analysis 
```{r message=FALSE,warning=FALSE}
data_cluster <- df_sandiego %>% dplyr::select(-c(x,y)) 
valid <- apply(data_cluster, MARGIN = 1, FUN = function(x){any(is.na(x)) == FALSE})
head(valid)
```  

<!-- ## Plots of cluster -->

<!-- # ```{r message=FALSE,warning=FALSE} -->
<!-- # for(i in 1:6) { -->
<!-- # km_out <- kmeans(data_cluster,center = 6,nstart = 20) -->
<!-- #       # Plot clusters -->
<!-- #       plot(x, col = km_out$cluster,  -->
<!-- #           main = km.out$tot.withinss,  -->
<!-- #           xlab = "", ylab = "") -->
<!-- #       } -->
<!-- # ``` -->

## Indentifying the best cluster 

```{r eval=FALSE,message=FALSE,warning=FALSE}
wss <- 0
for(i in 1:6) {
   # Run kmeans() on x with three clusters and one start
   km.out <- kmeans(data_cluster[valid,], centers = i, nstart = 20)
   wss[i] <- km.out$tot.withinss
}

plot(1:6, wss, type = "b", 
     xlab = "Number of Clusters", 
     ylab = "Within groups sum of squares")
```  

## Add new values of cluster 

```{r message=FALSE,warning=FALSE}
km_out <- kmeans(data_cluster[valid,], centers = 3, nstart = 20)
cluster_newdata <- cbind(dataset,km_out$cluster)
sandiego_cluster <- xydf %>%
   left_join(y = cluster_newdata,
             by = c('y','x')) %>% 
   dplyr::select(x, y, `km_out$cluster`)

```

## Mapping cluster 

```{r message=FALSE,warning=FALSE}
sandiego_crs  <- crs(brick_sandiego)
sandiego_res <- res(brick_sandiego)
kmean_raster <- rasterFromXYZ(
   sandiego_cluster,
   res = sandiego_res,
   crs = sandiego_crs)
```

## Plot cluster 

```{r message=FALSE,warning=FALSE}
levelplot(kmean_raster$km_out.cluster,
          col.regions = cpt('mpl_viridis'),
          main = "Kmean - cluster",
          margin = FALSE,
          xlab = '',
          ylab = '' ,
          colorkey = list(space = 'bottom')
          )
```

